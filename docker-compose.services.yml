services:
  # 知识库微服务
  ai-xia-services-knowledge:
    image: ai-xia-services-knowledge:latest
    build:
      context: .
      dockerfile: Dockerfile.knowledge
      pull: false  # 使用本地镜像，不拉取最新版本
    container_name: ai-xia-services-knowledge
    environment:
      # 连接到基础设施服务（使用服务名）
      DATABASE_URL: postgresql://postgres:postgres@postgres:5432/aihub?sslmode=disable
      REDIS_HOST: redis
      REDIS_PORT: 6379
      ELASTICSEARCH_URL: http://elasticsearch:9200
      MILVUS_ADDRESS: milvus:19530
      MINIO_ENDPOINT: minio:9000
      MINIO_ACCESS_KEY: M2PVBvdMCJk0kpg2TURT
      MINIO_SECRET_KEY: NCSxgvj8LEMMRuFr3x2EMcJdGwmSXY2vjZ4FpP2R
      KAFKA_BROKERS: kafka:9092
      DASHSCOPE_API_KEY: ${DASHSCOPE_API_KEY}
      DASHSCOPE_RERANK_MODEL: gte-rerank
      SERVER_PORT: 8001
      # 代理配置
      HTTP_PROXY: http://host.docker.internal:12334
      HTTPS_PROXY: http://host.docker.internal:12334
      http_proxy: http://host.docker.internal:12334
      https_proxy: http://host.docker.internal:12334
      NO_PROXY: localhost,127.0.0.1,postgres,redis,elasticsearch,milvus,minio,kafka,etcd,envoy
      no_proxy: localhost,127.0.0.1,postgres,redis,elasticsearch,milvus,minio,kafka,etcd,envoy
      # etcd 服务注册配置
      ETCD_ENABLED: "true"
      ETCD_ENDPOINTS: http://etcd:2379
      ETCD_SERVICE_NAME: ai-xia-services-knowledge
      ETCD_SERVICE_ID: ai-xia-services-knowledge-1
      SERVICE_HOST: ai-xia-services-knowledge
    ports:
      - "8001:8001"
    networks:
      - ai-xia-network
    # 注意：基础设施服务在另一个 compose 文件中，这里不设置 depends_on
    # 服务启动时会自动等待网络就绪
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8001/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Qwen模型服务
  qwen-model-service:
    build:
      context: ./qwen_service
      dockerfile: Dockerfile
    container_name: qwen-model-service
    environment:
      PORT: 8004
      QWEN_MODEL_PATH: ${QWEN_MODEL_PATH:-}
      QWEN_API_KEY: ${QWEN_API_KEY:-}
      QWEN_API_BASE: ${QWEN_API_BASE:-https://dashscope.aliyuncs.com/compatible-mode/v1}
      QWEN_LOCAL_MODE: ${QWEN_LOCAL_MODE:-true}
      HTTP_PROXY: http://host.docker.internal:12334
      HTTPS_PROXY: http://host.docker.internal:12334
      http_proxy: http://host.docker.internal:12334
      https_proxy: http://host.docker.internal:12334
      NO_PROXY: localhost,127.0.0.1
      no_proxy: localhost,127.0.0.1
    ports:
      - "8004:8004"
    networks:
      - ai-xia-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8004/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

networks:
  ai-xia-network:
    external: true
    name: backend_services-main_ai-xia-network

